import argparse
import importlib
import json

# set up command line arguments
parser = argparse.ArgumentParser()
parser.add_argument("exploit", nargs="?", help="the filename exploit to run", default=None)
parser.add_argument("--persistence", metavar="p", help="whether or not to run persistence", default=True, type=bool)
parser.add_argument("--exploits_file", metavar="ex", help="the json file to load the exploit list from", default="exploits.json", type=str)

# parse command line args
args = parser.parse_args()
print("Exploit Loader")

# variable to keep track of selected exploit
exploit = ""

# if exploit was passed to command line
if (args.exploit != None):
    
    # store exploit filename
    exploit = args.exploit
    
# otherwise, get user to select exploit
else:

    # parse exploit list
    exploits = {}
    with open(args.exploits_file, "r") as f:
        exploits = json.loads(f.read())["exploits"]
        
    # get user to select exploit
    while True:
        
        # print exploits
        print()
        for i in range(0, len(exploits)):
            
            exploit_name = exploits[i]["name"]
            print(f"{i+1:2} - {exploit_name}")
        
        print()
            
        # get input
        try:
            choice = input(f"Select an exploit (0 - {len(exploits)}): ")
            exploit_id = 0
        except KeyboardInterrupt:
            # user pressed ctrl+c
            print()
            break
        
        # cast input to int
        try: exploit_id = int(choice) - 1
        except ValueError:
            print("Please enter a number")
            continue
        
        # range check input
        if (exploit_id < 0) or (exploit_id >= len(exploits)):
            print("Please enter a number in the specified range")
            continue
        
        # get exploit filename
        exploit = exploits[exploit_id]["filename"]
        
        # exit loop
        break
    
# load exploit

if exploit == "":

    print("No exploit selected")

else:

    print("Loading", exploit)

    try:
        
        exploit_module = importlib.import_module("exploits." + exploit)
        print(f"Loaded module: {exploit_module.__name__}")
        
        # set up arguments to be passed to exploit
        args = {
            "persistence": args.persistence
        }
        
        # run module
        print("Running module...")
        
        print("\n-------------------- Exploit Start --------------------\n")
        exploit_module.runExploit(args)
        print("\n-------------------- Exploit  End  --------------------\n")
        
        print("Exploit Completed")
        
    except ModuleNotFoundError as e:
        
        print("Unable to find module", exploit, "-", e)
        
    except Exception as e:
        
        print(f"Error in module '{exploit}':", e)
        
